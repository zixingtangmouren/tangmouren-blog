<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前言 | 唐某人的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="这是唐某人的技术博客，用于记录平日里学习JS，Vue，Webpack，React的相关心得。">
    
    <link rel="preload" href="/tangmouren/assets/css/0.styles.14446835.css" as="style"><link rel="preload" href="/tangmouren/assets/js/app.6489800f.js" as="script"><link rel="preload" href="/tangmouren/assets/js/2.18399b14.js" as="script"><link rel="preload" href="/tangmouren/assets/js/10.fbff40b9.js" as="script"><link rel="prefetch" href="/tangmouren/assets/js/11.12521ef0.js"><link rel="prefetch" href="/tangmouren/assets/js/12.eed0a89c.js"><link rel="prefetch" href="/tangmouren/assets/js/13.afff178a.js"><link rel="prefetch" href="/tangmouren/assets/js/3.d7d6cdd2.js"><link rel="prefetch" href="/tangmouren/assets/js/4.09ee8a39.js"><link rel="prefetch" href="/tangmouren/assets/js/5.98155bf4.js"><link rel="prefetch" href="/tangmouren/assets/js/6.498ab014.js"><link rel="prefetch" href="/tangmouren/assets/js/7.57ce6d61.js"><link rel="prefetch" href="/tangmouren/assets/js/8.83873d28.js"><link rel="prefetch" href="/tangmouren/assets/js/9.719aaf58.js">
    <link rel="stylesheet" href="/tangmouren/assets/css/0.styles.14446835.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/tangmouren/" class="home-link router-link-active"><!----> <span class="site-name">唐某人的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/tangmouren/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/tangmouren/JS/" class="nav-link">
  JS
</a></div><div class="nav-item"><a href="/tangmouren/Vue/" class="nav-link router-link-active">
  Vue
</a></div><div class="nav-item"><a href="/tangmouren/Webpack/" class="nav-link">
  Webpack
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/tangmouren/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/tangmouren/JS/" class="nav-link">
  JS
</a></div><div class="nav-item"><a href="/tangmouren/Vue/" class="nav-link router-link-active">
  Vue
</a></div><div class="nav-item"><a href="/tangmouren/Webpack/" class="nav-link">
  Webpack
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Vue原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/tangmouren/Vue/" aria-current="page" class="sidebar-link">开始</a></li><li><a href="/tangmouren/Vue/vue3组件通信.html" class="active sidebar-link">vue3组件通信</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tangmouren/Vue/vue3组件通信.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/tangmouren/Vue/vue3组件通信.html#基本操作" class="sidebar-link">基本操作</a></li><li class="sidebar-sub-header"><a href="/tangmouren/Vue/vue3组件通信.html#父传子" class="sidebar-link">父传子</a></li><li class="sidebar-sub-header"><a href="/tangmouren/Vue/vue3组件通信.html#父传更深的后代" class="sidebar-link">父传更深的后代</a></li><li class="sidebar-sub-header"><a href="/tangmouren/Vue/vue3组件通信.html#子传父" class="sidebar-link">子传父</a></li><li class="sidebar-sub-header"><a href="/tangmouren/Vue/vue3组件通信.html#事件中心进阶" class="sidebar-link">事件中心进阶</a></li><li class="sidebar-sub-header"><a href="/tangmouren/Vue/vue3组件通信.html#深层后代向顶层通信-兄弟通信" class="sidebar-link">深层后代向顶层通信，兄弟通信</a></li><li class="sidebar-sub-header"><a href="/tangmouren/Vue/vue3组件通信.html#最后" class="sidebar-link">最后</a></li></ul></li><li><a href="/tangmouren/Vue/实现一个简单的Vue3框架.html" class="sidebar-link">实现一个简单的Vue3框架</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>最近在咱们社区看到一位大佬的这篇文章<a href="https://juejin.cn/post/6903796293445877773" target="_blank" rel="noopener noreferrer">Vue 组件通信方式及其应用场景总结<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，感觉对<code>vue2</code>的通信方式和应用场景总结的非常到位，所以向大佬 salute😄。刚好最近在学习<code>vue3</code>，于是也思考总结一下在<code>vue3</code>中的组件通信的方式。</p> <p>我们知道<code>vue3</code>的<code>Composition Api</code>是它几个最大亮点之一，所以下文都是在<code>setup</code>中演示代码的实现。后面会以开发几个简单<code>form组件</code>为例子来演示。</p> <h2 id="基本操作"><a href="#基本操作" class="header-anchor">#</a> 基本操作</h2> <p>这里先简单开发一个<code>VInput</code>的输入框组件。组件就像一个函数，主要就是处理输入和输出。<code>Vue3</code>在<code>setup</code>函数上提供了两个参数，一个<code>props</code>，一个是<code>context</code>下面的<code>emit</code>方法，分别来处理输入和输出。</p> <h3 id="props"><a href="#props" class="header-anchor">#</a> props</h3> <p>现在<code>VInput</code>就是子组件，我需要它能够接受父级传递一个值，让它可以帮我做后续的逻辑处理在返回给父级。所以，这里需要最基本的一些父子通信方式<code>v-bind</code>，<code>props</code>。</p> <p><strong>父级组件中</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
   <span class="token comment">// 通过v-bind将数据想子组件传递</span>
  <span class="token operator">&lt;</span>VInput <span class="token operator">:</span>value<span class="token operator">=</span><span class="token string">&quot;valueRef&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token keyword">const</span> valueRef <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>VInput 中</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>input <span class="token operator">:</span>value<span class="token operator">=</span><span class="token string">&quot;value&quot;</span> <span class="token keyword">type</span><span class="token operator">=</span><span class="token string">&quot;text&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script lang<span class="token operator">=</span><span class="token string">&quot;ts&quot;</span><span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'VInput'</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    value<span class="token operator">:</span> String
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 其他逻辑</span>

    <span class="token comment">// 接受到这个值</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><h3 id="emit"><a href="#emit" class="header-anchor">#</a> emit</h3> <p>当我们在组件中接受参数，进行一些逻辑处理后，我们就需要将处理好的值，向外部进行一个返回，外部同时需要实现一个事件函数去接受。此时我就可以使用<code>emit</code>方法</p> <p>假设我们希望<code>VInput</code>组件返回给外部的是一个限制长度的字符串。此时外部就需要实现一个对应的事件函数去接收这个值，然后<code>VInput</code>内部通<code>emit</code>执行事件，将内部的处理好的值当做参数返回出去。</p> <p><strong>VInput</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>input <span class="token operator">:</span>value<span class="token operator">=</span><span class="token string">&quot;value&quot;</span> <span class="token keyword">type</span><span class="token operator">=</span><span class="token string">&quot;text&quot;</span> @input<span class="token operator">=</span><span class="token string">&quot;onInput&quot;</span> ref<span class="token operator">=</span><span class="token string">&quot;inputRef&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script lang<span class="token operator">=</span><span class="token string">&quot;ts&quot;</span><span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'VInput'</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    value<span class="token operator">:</span> String<span class="token punctuation">,</span>
    maxLength<span class="token operator">:</span> Number
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> <span class="token punctuation">{</span> emit <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// Vue3中获取组件或者dom实例的一种方式</span>
    <span class="token keyword">const</span> inputRef <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 限制文字长度</span>
    <span class="token keyword">const</span> <span class="token function-variable function">limitLength</span> <span class="token operator">=</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> maxLength<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
      value<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> maxLength<span class="token punctuation">)</span>


    <span class="token comment">// 输入控制</span>
    <span class="token keyword">const</span> <span class="token function-variable function">controlled</span> <span class="token operator">=</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      inputRef<span class="token punctuation">.</span>value<span class="token punctuation">.</span>value <span class="token operator">=</span> value
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> <span class="token function-variable function">onInput</span> <span class="token operator">=</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> value <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> props<span class="token punctuation">.</span>maxLength <span class="token operator">===</span> <span class="token string">'number'</span> <span class="token operator">&amp;&amp;</span> props<span class="token punctuation">.</span>maxLength <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        value <span class="token operator">=</span> <span class="token function">limitLength</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> props<span class="token punctuation">.</span>maxLength<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token function">controlled</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>

      <span class="token comment">// 向外部返回一个处理过的值</span>
      <span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'onInput'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      onInput<span class="token punctuation">,</span>
      inputRef
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p><strong>父级组件</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token comment">// 通过v-on向子组件传递一个函数，用户接受返回值</span>
  <span class="token operator">&lt;</span>VInput <span class="token operator">:</span>value<span class="token operator">=</span><span class="token string">&quot;valueRef&quot;</span> <span class="token operator">:</span>maxLength<span class="token operator">=</span><span class="token string">&quot;10&quot;</span> @onInput<span class="token operator">=</span><span class="token string">&quot;onInput&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script lang<span class="token operator">=</span><span class="token string">&quot;ts&quot;</span><span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> VInput <span class="token keyword">from</span> <span class="token string">'@/components/VInput.vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'Demo'</span><span class="token punctuation">,</span>
  components<span class="token operator">:</span> <span class="token punctuation">{</span>
    VInput
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> valueRef <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> <span class="token function-variable function">onInput</span> <span class="token operator">=</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       <span class="token comment">// 接受子组件VInput返回的值</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
      <span class="token comment">// 改变对应的值</span>
      valueRef<span class="token punctuation">.</span>value <span class="token operator">=</span> value
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      valueRef<span class="token punctuation">,</span>
      onInput
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>对于这种<code>input</code>的组件的使用，我猜大家肯定都不想在父级组件这么麻烦的去接收和改变一个值，所以<code>vue</code>是提供了<code>v-model</code>来更快捷的实现输入和输出。</p> <h3 id="v-model"><a href="#v-model" class="header-anchor">#</a> v-model</h3> <p>通过<code>Vue3</code>的文档可以发现，这个指令的用法发生了一定的变化。在之前，我们要想实现一个<strong>自定义的非表单组件</strong>的双向绑定，需要通过<code>xxxx.sync</code>的这种语法来实现，如今这个指令已经被废除了，而是统一使用<code>v-model</code>这个指令。</p> <p><strong>父级组件</strong></p> <p>新的<code>v-model</code> 还可以支持多个数据的双向绑定。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>VBtn v<span class="token operator">-</span>model<span class="token operator">:</span>value<span class="token operator">=</span><span class="token string">&quot;valueRef&quot;</span> v<span class="token operator">-</span>model<span class="token operator">:</span>keyword<span class="token operator">=</span><span class="token string">&quot;keywordRef&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>
</code></pre></div><p><strong>自定义的非表单组件</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>button @click<span class="token operator">=</span><span class="token string">&quot;clickHandle&quot;</span><span class="token operator">&gt;</span>click<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'VBtn'</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    value<span class="token operator">:</span> String<span class="token punctuation">,</span>
    keyword<span class="token operator">:</span> String
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> <span class="token punctuation">{</span> emit <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// 省略其他代码</span>

     <span class="token comment">// 用户点击按钮</span>
    <span class="token keyword">const</span> <span class="token function-variable function">clickHandle</span> <span class="token operator">=</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 省略其他代码</span>

      <span class="token comment">// 修改对应的props的数据</span>
      <span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'update:value'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
      <span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'update:keyword'</span><span class="token punctuation">,</span> value <span class="token operator">+</span> <span class="token string">'123'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><p>以上就是在<code>Vue3</code>中一些基本通信方式的 API 的介绍。在<code>Vue3</code>中一般都是采用<code>Composition Api</code>的形式开发，所以你会发现开发的时候不能在采用<code>this.$xxx</code>的方式去调用实例上的某个函数或者是属性。那些<code>this.$parent</code>，<code>this.$children</code>，<code>this.$on</code>，<code>this.$emit</code>等等都不能在使用了。</p> <p>那在<code>Vue3</code>中如何解决组件间那些通信的呢？咱们从简单到复杂的场景，一个个来分析。</p> <p>先来看一下，开发的三个<code>form</code>组件，组合起来的实际的用法是怎么样的:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>ValidateForm ref<span class="token operator">=</span><span class="token string">&quot;validateFormRef1&quot;</span> <span class="token operator">:</span>model<span class="token operator">=</span><span class="token string">&quot;state&quot;</span> <span class="token operator">:</span>rules<span class="token operator">=</span><span class="token string">&quot;rules&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>ValidateFormItem label<span class="token operator">=</span><span class="token string">&quot;用户名&quot;</span> prop<span class="token operator">=</span><span class="token string">&quot;keyword&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>ValidateInput
        placeholder<span class="token operator">=</span><span class="token string">&quot;请输入&quot;</span>
        required
        v<span class="token operator">-</span>model<span class="token operator">:</span>modelValue<span class="token operator">=</span><span class="token string">&quot;state.keyword&quot;</span>
      <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ValidateFormItem<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>ValidateFormItem label<span class="token operator">=</span><span class="token string">&quot;密码&quot;</span> prop<span class="token operator">=</span><span class="token string">&quot;password&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>ValidateInput
        placeholder<span class="token operator">=</span><span class="token string">&quot;请输入&quot;</span>
        required
        <span class="token keyword">type</span><span class="token operator">=</span><span class="token string">&quot;password&quot;</span>
        v<span class="token operator">-</span>model<span class="token operator">:</span>modelValue<span class="token operator">=</span><span class="token string">&quot;state.password&quot;</span>
      <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ValidateFormItem<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>ValidateForm<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>button <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn btn-primary&quot;</span> @click<span class="token operator">=</span><span class="token string">&quot;submit(0)&quot;</span><span class="token operator">&gt;</span>提交<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>
</code></pre></div><p>所有组件的功能，是模仿<code>Element UI</code>去实现的。</p> <h2 id="父传子"><a href="#父传子" class="header-anchor">#</a> 父传子</h2> <p>父组件向子组件传递一个数据，可以用这两种方式：</p> <ul><li>v-bind</li> <li>refs 获取子组件内部某个函数，直接调用传参（这里简称 refs 方式）</li></ul> <h3 id="refs-方式"><a href="#refs-方式" class="header-anchor">#</a> refs 方式</h3> <p>关于<code>v-bind</code>咱们就不细说了，在基本操作章节已经讲过其对应的使用方式了。这小节主要在中讲<code>Vue3</code>如何通过<code>ref</code>获取子组件实例并调用其身上的函数来对子组件进行传值。</p> <p><strong>子组件</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token comment">// 渲染从父级接受到的值</span>
  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Son<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> valueRef <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script lang<span class="token operator">=</span><span class="token string">&quot;ts&quot;</span><span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'Son'</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> valueRef <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>

    <span class="token comment">// 该函数可以接受父级传递一个参数，并修改valueRef的值</span>
    <span class="token keyword">const</span> <span class="token function-variable function">acceptValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>valueRef<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      acceptValue<span class="token punctuation">,</span>
      valueRef
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p><strong>父组件</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>sonRef<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>button @click<span class="token operator">=</span><span class="token string">&quot;sendValue&quot;</span><span class="token operator">&gt;</span>send<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
  <span class="token comment">// 这里ref接受的字符串，要setup返回的ref类型的变量同名</span>
  <span class="token operator">&lt;</span>Son ref<span class="token operator">=</span><span class="token string">&quot;sonRef&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script lang<span class="token operator">=</span><span class="token string">&quot;ts&quot;</span><span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> Son <span class="token keyword">from</span> <span class="token string">'@/components/Son.vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'Demo'</span><span class="token punctuation">,</span>
  components<span class="token operator">:</span> <span class="token punctuation">{</span>
    Son
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果ref初始值是一个空，可以用于接受一个实例</span>
    <span class="token comment">// vue3中获取实例的方式和vue2略有不同</span>
    <span class="token keyword">const</span> sonRef <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> <span class="token function-variable function">sendValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 可以拿到son组件实例，并调用其setup返回的所有信息</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sonRef<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

      <span class="token comment">// 通过调用son组件实例的方法，向其传递数据</span>
      sonRef<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">acceptValue</span><span class="token punctuation">(</span><span class="token string">'123456'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      sonRef<span class="token punctuation">,</span>
      sendValue
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>这里可以看一下流程图：
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1dad085f528c47a49fee4ee2daa3f177~tplv-k3u1fbpfcp-watermark.image" alt="">
其实这种方式跟<code>Vue2</code>中使用<code>this.$refs</code>，<code>this.$children</code>的方式很相似，都是通过拿到子组件实例，直接调用子组件身上的函数。方法千篇一律，不过在<code>Vue3</code>中没有了<code>this</code>这个黑盒。</p> <p>这里我们可以在控制台看一下这个<code>sonRef.value</code>是一个怎样的东西。</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e60113a245aa407090ceb65b280c09ea~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>可以发现，通过<code>ref</code>获取到的子组件实例上面可以拿到<code>setup</code>返回的所有变量和方法，同时还可以拿到其他的一些内部属性。我们可以看一下官方文档<a href="https://vue-composition-api-rfc.netlify.app/zh/api.html#%E6%A8%A1%E6%9D%BF-refs" target="_blank" rel="noopener noreferrer">Vue 组合式 API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的描述。</p> <blockquote><p>在 Virtual DOM patch 算法中，如果一个 VNode 的 ref 对应一个渲染上下文中的 ref，则该 VNode 对应的元素或组件实例将被分配给该 ref。 这是在 Virtual DOM 的 mount / patch 过程中执行的，因此模板 ref 仅在渲染初始化后才能访问。</p></blockquote> <p><strong>ref 方式总结</strong></p> <p>优点：</p> <ol><li>父组件可以获取快速向<strong>确定存在的</strong>子组件传递数据</li> <li>传递的参数不受限制，传递方式比较灵活</li></ol> <p>缺点：</p> <ol><li>ref 获取的子组件必须确定存在的（不确定存在的情况：如插槽上子组件，<code>v-if</code>控制的子组件）</li> <li>子组件还需要实现接受参数的方法</li></ol> <h2 id="父传更深的后代"><a href="#父传更深的后代" class="header-anchor">#</a> 父传更深的后代</h2> <p>一般往深度层级传递值，有这两种方式：</p> <ul><li>provide / inject</li> <li>vuex</li></ul> <h3 id="provide-inject"><a href="#provide-inject" class="header-anchor">#</a> provide / inject</h3> <p>一看到“深”这个字，大家肯定第一想到的就<code>Vue2</code>中的<code>provide / inject</code>选项。没错，这套逻辑在<code>vue3</code>中同样适用，这两个选项变成了两个方法。</p> <p><code>provide</code>允许我们向当前组件的所有后代组件，传递一份数据，所有后代组件能够通过<code>inject</code>这个方法来决定是否接受这份数据。</p> <p>大致的示意图如下：
<img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ab59c36dfe594131a5f3fb7734ee92c6~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p><strong>实际应用场景</strong></p> <p>主要应用的场景有两中，一种深度传递一个参数或者一个函数的时候，另一种是给插槽上不确定性的组件传参的时候。</p> <p>重点说一下给插槽上的组件传参。先实现一个最外层的<code>ValidateForm</code>组件，它主要负责接受一整个表单数据和整个表单数据的校验规则。其内部提供了一个插槽，用于放置一些不确定性的组件。还有一个<code>ValidateFormItem</code>组件可以接受一个字段名，通过这字段名准确知道需要校验哪个字段（tips:功能其实和<code>element-ui</code>类似）。</p> <p>组件化开发，需要将参数和功能进行解耦，所以我们这样来设计：</p> <ul><li><code>ValidateForm</code>：<code>model</code>，<code>rules</code>，只管接受整份表单的数据和校验规则</li> <li><code>ValidateFormItem</code>：<code>prop</code>，只管接受字段名，只需知道自己需要验证哪一个字段</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>ValidateForm ref<span class="token operator">=</span><span class="token string">&quot;validateFormRef&quot;</span> <span class="token operator">:</span>model<span class="token operator">=</span><span class="token string">&quot;formData&quot;</span> <span class="token operator">:</span>rules<span class="token operator">=</span><span class="token string">&quot;rules&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>ValidateFormItem label<span class="token operator">=</span><span class="token string">&quot;用户名&quot;</span> prop<span class="token operator">=</span><span class="token string">&quot;keyword&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> field组件 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ValidateFormItem<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>ValidateFormItem label<span class="token operator">=</span><span class="token string">&quot;密码&quot;</span> prop<span class="token operator">=</span><span class="token string">&quot;password&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> field组件 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ValidateFormItem<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>ValidateForm<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>
</code></pre></div><p>如果<code>ValidateFormItem</code>组件需要通过<code>prop</code>去效验某个字段，那它就需要拿到那份表单的数据，通过<code>formData[prop]</code>去取到那个字段的值，那这份<code>formData</code>从哪里来呢？首先不可能每写一个<code>ValidateFormItem</code>组件都传递一份。因为，实际开发中我们并不能确定在<code>ValidateForm</code>下要写多少个<code>ValidateFormItem</code>组件，如果每写一个都手动传递一份表单的数据，这些写起来就会多了很多冗余的代码而且也很麻烦。所以，就由<code>ValidateForm</code>这个组件独立接受并分发下来。</p> <p><strong>ValidateForm</strong></p> <p>所以我们需要<code>ValidateForm</code>来向下分发数据。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>form<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>slot<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>slot<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script lang<span class="token operator">=</span><span class="token string">&quot;ts&quot;</span><span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> provide <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> modelKey <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> rulesKey <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'ValidateForm'</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    model<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">type</span><span class="token operator">:</span> Object
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    rules<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">type</span><span class="token operator">:</span> Object
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 向后代发放数据</span>
    <span class="token function">provide</span><span class="token punctuation">(</span>modelKey<span class="token punctuation">,</span> props<span class="token punctuation">.</span>model<span class="token punctuation">)</span>
    <span class="token function">provide</span><span class="token punctuation">(</span>rulesKey<span class="token punctuation">,</span> props<span class="token punctuation">.</span>rules<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p><strong>ValidateFormItem</strong></p> <p><code>ValidateFormItem</code>接受上面传递的数据。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">&lt;</span>script lang<span class="token operator">=</span><span class="token string">&quot;ts&quot;</span><span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> reactive<span class="token punctuation">,</span> inject<span class="token punctuation">,</span> provide <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> modelKey<span class="token punctuation">,</span> rulesKey <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./ValidateForm.vue'</span>


<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'ValidateFormItem'</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    label<span class="token operator">:</span> String<span class="token punctuation">,</span>
    required<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">type</span><span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
      <span class="token keyword">default</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    prop<span class="token operator">:</span> String
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 接受ValidateForm传下来的数据</span>
    <span class="token keyword">const</span> model <span class="token operator">=</span> <span class="token generic-function"><span class="token function">inject</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>modelKey<span class="token punctuation">,</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> rules <span class="token operator">=</span> <span class="token generic-function"><span class="token function">inject</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>rulesKey<span class="token punctuation">,</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// 根据props.prop在model和rules分别取出需要 校验的数据 和 校验的规则</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>model<span class="token punctuation">[</span>props<span class="token punctuation">.</span>prop<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rules<span class="token punctuation">[</span>props<span class="token punctuation">.</span>prop<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment">// 数据校验的逻辑</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token comment">//...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p><strong>provide / inject 总结</strong></p> <p>在这篇文章<a href="https://juejin.cn/post/6903796293445877773" target="_blank" rel="noopener noreferrer">Vue 组件通信方式及其应用场景总结<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中，大佬对其的优缺点已经总结很好了。这里提一下它的缺点，就是不能解决兄弟组件的通信。</p> <h3 id="vuex"><a href="#vuex" class="header-anchor">#</a> vuex</h3> <p><code>vuex</code>一直以来是<code>vue</code>生态中一个解决不同层级组件数据共享的优质方案。不仅是在父传子中可以适用，在子传父，或者祖先传后代，后代传祖先，兄弟组件间都是一个非常好的方案。因为它是一个集中状态管理模式。其本质实现也是响应式的。这里只简单提一下<code>Vue3</code>中是如何使用的。</p> <p><strong>创建一个<code>store</code></strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vuex'</span>

<span class="token keyword">export</span> <span class="token keyword">enum</span> Mutarions <span class="token punctuation">{</span>
  <span class="token constant">SET_COUNT</span> <span class="token operator">=</span> <span class="token string">'SET_COUNT'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">createStore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  state<span class="token operator">:</span> <span class="token punctuation">{</span>
    count<span class="token operator">:</span> <span class="token number">231</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  getters<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">count</span><span class="token operator">:</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">.</span>count<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  mutations<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>Mutarions<span class="token punctuation">.</span><span class="token constant">SET_COUNT</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">(</span>state<span class="token punctuation">,</span> num<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>count <span class="token operator">=</span> num<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>父组件</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>father<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>

  <span class="token operator">&lt;</span>Son ref<span class="token operator">=</span><span class="token string">&quot;sonRef&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script lang<span class="token operator">=</span><span class="token string">&quot;ts&quot;</span><span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> Son <span class="token keyword">from</span> <span class="token string">'@/components/Son.vue'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vuex'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Mutarions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/store/index'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'Father'</span><span class="token punctuation">,</span>
  components<span class="token operator">:</span> <span class="token punctuation">{</span>
    Son
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> valueRef <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">useStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    store<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>Mutarions<span class="token punctuation">.</span><span class="token constant">SET_COUNT</span><span class="token punctuation">,</span> valueRef<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p><strong>子组件</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Son<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> count <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script lang<span class="token operator">=</span><span class="token string">&quot;ts&quot;</span><span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> computed <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vuex'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'Son'</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">useStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> store<span class="token punctuation">.</span>getters<span class="token punctuation">.</span>count<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      count
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><h2 id="子传父"><a href="#子传父" class="header-anchor">#</a> 子传父</h2> <p>子级向父级传递数据，可以有这三种方式：</p> <ul><li>v-on</li> <li>refs 方式</li> <li>事件中心</li></ul> <h3 id="refs-方式-2"><a href="#refs-方式-2" class="header-anchor">#</a> refs 方式</h3> <p>通过<code>ref</code>的方式向父级传递一个数据是同样适用的。具体思路：子组件内部实现一个函数，该函数可以返回一个值。父级组件通过<code>ref</code>取到子组件实例后调用该方法，得到需要的返回值。</p> <p>这里来看一下实际的应用场景，我们希望<code>ValidateForm</code>组件去验证下面所有的表单项，然后通过一个函数将组件内部的一个验证状态返回出去。</p> <p><strong>父组件</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>ValidateForm ref<span class="token operator">=</span><span class="token string">&quot;validateFormRef&quot;</span> <span class="token operator">:</span>model<span class="token operator">=</span><span class="token string">&quot;formData&quot;</span> <span class="token operator">:</span>rules<span class="token operator">=</span><span class="token string">&quot;rules&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>ValidateFormItem label<span class="token operator">=</span><span class="token string">&quot;用户名&quot;</span> prop<span class="token operator">=</span><span class="token string">&quot;keyword&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> field组件 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ValidateFormItem<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>ValidateFormItem label<span class="token operator">=</span><span class="token string">&quot;密码&quot;</span> prop<span class="token operator">=</span><span class="token string">&quot;password&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> field组件 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ValidateFormItem<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>ValidateForm<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script lang<span class="token operator">=</span><span class="token string">&quot;ts&quot;</span><span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'demo'</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 省略部分代码</span>

    <span class="token keyword">const</span> validateFormRef <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 通过validate拿到ValidateForm组件内部的一个验证状态</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>validateFormRef<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 表单验证成功后，做后续的操作</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      validateFormRef
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p><strong>ValidateForm</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>form<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>slot<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>slot<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script lang<span class="token operator">=</span><span class="token string">&quot;ts&quot;</span><span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'ValidateForm'</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">validate</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token comment">// 调用插槽下所有ValidateFormItem组件内部的校验方法</span>
      <span class="token comment">//（tips:至于如何调用，后面的事件中心会重点说）</span>
      <span class="token comment">// 如果有一个校验方法返回的是false就直接返回false</span>
      <span class="token comment">// 如果都为true就返回一个true</span>

      <span class="token keyword">return</span> result
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      validate
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>这里来看一下大致的流程图：</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/17111a8ec61c46a193e6177d5a25cdcd~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>通过该种方法还可以拿到子组件内部的数据，这就跟闭包函数一样的道理。</p> <h3 id="事件中心"><a href="#事件中心" class="header-anchor">#</a> 事件中心</h3> <p>这种通信方式为什么拿到这里来讲呢？因为我觉接下的实际案例用上事件中心这种方式会非常的恰当。在上一个小节中，我们留下来一个坑，那就是<code>ValidateForm</code>组件要去验证整个表单是否通过，就必须想办法让每个<code>ValidateFormItem</code>将内部的校验结果返回给它。</p> <p><strong>首先会遇到两个问题</strong></p> <ol><li><code>ValidateForm</code>下面的组件是通过插槽去挂载的，所以无法通过<code>ref</code>的方式去拿到每个子表单项的实例，所以就没办法拿到每个<code>ValidateFormItem</code>的验证状态了。</li> <li>上面的章节中有一个图片，展示了通过<code>ref</code>拿到的组件实例。可以发现，你可以找到<code>$parent</code>属性，但是没有<code>$children</code>属性。这就很尴尬了，我们没办法像<code>Vue2</code>一样在<code>ValidateForm</code>中通过<code>$children</code>拿到每个子组件的实例。</li></ol> <p><strong>解决思路</strong></p> <p>既然没有办法拿到插槽上的组件实例，那咱们就绕开它，通过一个事件中心的方式来解决。思路是这样的：</p> <ol><li>在<code>ValidateForm</code>实例初始化的时候，去创建一个事件中心<code>Emitter</code>实例，它可以注册一个事件，当这个事件被执行时可以接受一个函数，并存在一个队列中。</li> <li>将这个<code>Emitter</code>通过<code>provide</code>传递给后代，保证这个事件中心在不同的<code>ValidateForm</code>组件中都是独立的。换句话说，就是如果写了多个<code>ValidateForm</code>，他们的事件中心不会相互干扰。</li> <li>在<code>ValidateFormItem</code>中使用<code>inject</code>接收自己所在表单域的<code>Emitter</code>，在挂载的时候，执行<code>Emitter</code>上的事件，将自己的内部的<code>validate</code>函数，传递发送给<code>ValidateForm</code>，并由其将方法缓存在队列中。</li> <li><code>ValidateForm</code>执行校验的时候，就可以执行队列中的所有校验函数，并得出校验结果。</li></ol> <p>具体代码实现：</p> <p>先来实现一个<code>Emitter</code>事件中心的类</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> EmitterHandles <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/type/utils'</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Emitter</span> <span class="token punctuation">{</span>
  <span class="token comment">// 存放事件函数</span>
  <span class="token keyword">private</span> events<span class="token operator">:</span> EmitterHandles <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// 用于注册事件</span>
  <span class="token function">on</span><span class="token punctuation">(</span>eventName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> eventHandle<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span> <span class="token operator">=</span> eventHandle
  <span class="token punctuation">}</span>

  <span class="token comment">// 删除事件</span>
  <span class="token function">off</span><span class="token punctuation">(</span>eventName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 触发事件</span>
  <span class="token function">emit</span><span class="token punctuation">(</span>eventName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token operator">...</span>rest<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>rest<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当事件中心实现好了，这里来完善一下<code>ValidateForm</code>的代码</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">&lt;</span>script lang<span class="token operator">=</span><span class="token string">&quot;ts&quot;</span><span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> nextTick<span class="token punctuation">,</span> provide <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Emitter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/utils/emitter'</span>

<span class="token keyword">type</span> <span class="token class-name">ValidateFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">boolean</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> emitterKey <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> modelKey <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> rulesKey <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'ValidateForm'</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    model<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">type</span><span class="token operator">:</span> Object
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    rules<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">type</span><span class="token operator">:</span> Object
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将表单数据和验证规则传递给后代</span>
    <span class="token function">provide</span><span class="token punctuation">(</span>modelKey<span class="token punctuation">,</span> props<span class="token punctuation">.</span>model<span class="token punctuation">)</span>
    <span class="token function">provide</span><span class="token punctuation">(</span>rulesKey<span class="token punctuation">,</span> props<span class="token punctuation">.</span>rules<span class="token punctuation">)</span>

    <span class="token comment">// 创建事件中心的实例</span>
    <span class="token keyword">const</span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Emitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 将事件中心传递给后代</span>
    <span class="token function">provide</span><span class="token punctuation">(</span>emitterKey<span class="token punctuation">,</span> emitter<span class="token punctuation">)</span>

    <span class="token comment">// 接受formItem组件返回的验证函数</span>
    <span class="token comment">// 并且将其存起来</span>
    emitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'acceptValidate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>validateFunc<span class="token operator">:</span> ValidateFunc<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      validateList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>validateFunc<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 用于接受保存后代返回的验证方法</span>
    <span class="token keyword">const</span> validateList<span class="token operator">:</span> ValidateFunc<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token comment">// 验证所有数据的状态</span>
    <span class="token keyword">const</span> <span class="token function-variable function">validate</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 执行每一个子表单发送过来的验证方法</span>
     <span class="token keyword">return</span> validateList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>fn <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span>valid <span class="token operator">=&gt;</span> valid<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      validate
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>ok，现在实现了<code>validateForm</code>的逻辑，我们再来写一下<code>validateFormItem</code>的逻辑</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;form-group&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>label v<span class="token operator">-</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string">&quot;label&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot; col-form-label&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> label <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>slot<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>slot<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>small v<span class="token operator">-</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string">&quot;error.isError&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;invalid-feedback&quot;</span><span class="token operator">&gt;</span>
      <span class="token punctuation">{</span><span class="token punctuation">{</span> error<span class="token punctuation">.</span>errorMessage <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>small<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script lang<span class="token operator">=</span><span class="token string">&quot;ts&quot;</span><span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Emitter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/utils/emitter'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> reactive<span class="token punctuation">,</span> inject<span class="token punctuation">,</span> onMounted<span class="token punctuation">,</span> provide <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> emitterProviderKey<span class="token punctuation">,</span> modelKey<span class="token punctuation">,</span> rulesKey <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./ValidateForm.vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'ValidateFormItem'</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    label<span class="token operator">:</span> String<span class="token punctuation">,</span>
    required<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">type</span><span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
      <span class="token keyword">default</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    prop<span class="token operator">:</span> String
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 接受Emitter事件中心</span>
    <span class="token keyword">const</span> emitter <span class="token operator">=</span> <span class="token generic-function"><span class="token function">inject</span><span class="token generic class-name"><span class="token operator">&lt;</span>Emitter<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>emitterProviderKey<span class="token punctuation">)</span>
    <span class="token comment">// 接受数据和校验规则</span>
    <span class="token keyword">const</span> model <span class="token operator">=</span> <span class="token generic-function"><span class="token function">inject</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>modelKey<span class="token punctuation">)</span>
    <span class="token keyword">const</span> rules <span class="token operator">=</span> <span class="token generic-function"><span class="token function">inject</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>rulesKey<span class="token punctuation">)</span>

    <span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      isError<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      errorMessage<span class="token operator">:</span> <span class="token string">''</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 校验对应的字段数据</span>
    <span class="token keyword">const</span> <span class="token function-variable function">validateField</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> prop <span class="token operator">=</span> props<span class="token punctuation">.</span>prop
      <span class="token keyword">if</span> <span class="token punctuation">(</span>prop <span class="token operator">&amp;&amp;</span> model <span class="token operator">&amp;&amp;</span> rules <span class="token operator">&amp;&amp;</span> rules<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> rules<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>item<span class="token punctuation">.</span><span class="token function">validator</span><span class="token punctuation">(</span>model<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prop<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
            error<span class="token punctuation">.</span>isError <span class="token operator">=</span> <span class="token boolean">true</span>
            error<span class="token punctuation">.</span>errorMessage <span class="token operator">=</span> item<span class="token punctuation">.</span>message
            <span class="token keyword">return</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">!</span>result
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>


    <span class="token comment">// 当组件挂载的时候，将自身的校验函数发送给ValidateForm组件</span>
    <span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      emitter <span class="token operator">&amp;&amp;</span> emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'acceptValidate'</span><span class="token punctuation">,</span> validateField<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      error
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>为了更详细的理解上面的过程，这里来画一个示意图：</p> <ol><li>注册事件，分发事件中心</li></ol> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f8266bd8e41b4d1a9322b4d92f43ccc8~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <ol start="2"><li>执行事件，发送验证函数</li></ol> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/57255b6f8a9f4f9bb6f51fd015891a46~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>整个过程的总结就是，顶层组件创建和分发事件中心，并注册事件监听函数。后代组件执行该事件然后发送信息，顶层组件回收信息。</p> <p><strong>Tips</strong></p> <p>这里再提一点，在使用<code>Emitter</code>这个事件中心的时候，是在<code>ValidateForm</code>的<code>setup</code>中去创建并且去下发的，并不是使用一个全局的事件中心。就像大佬的这篇文章<a href="https://juejin.cn/post/6903796293445877773" target="_blank" rel="noopener noreferrer">Vue 组件通信方式及其应用场景总结<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中总结到的，事件总线的形式是有一个致命缺点的，如果一个页面上有多个公共组件，我们只要向其中的一个传递数据，但是每个公共组件都绑定了数据接受的方法，那就会出现混乱的情况。但是，我们的事件总线不是一个全局的，而是单个作用域里面的一个事件中心。</p> <p>因为事件中心是在当前组件内部创建，并使用<code>provide</code>向下发布的，这样就只有当前组件的后代才能使用这个事件中心。所以，就算一个面上写了多个<code>ValidateForm</code>，他们的校验都是独立的。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>ValidateForm ref<span class="token operator">=</span><span class="token string">&quot;validateFormRef1&quot;</span> <span class="token operator">:</span>model<span class="token operator">=</span><span class="token string">&quot;formData1&quot;</span> <span class="token operator">:</span>rules<span class="token operator">=</span><span class="token string">&quot;rules&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>ValidateFormItem label<span class="token operator">=</span><span class="token string">&quot;用户名&quot;</span> prop<span class="token operator">=</span><span class="token string">&quot;keyword&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> field组件 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ValidateFormItem<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>ValidateFormItem label<span class="token operator">=</span><span class="token string">&quot;密码&quot;</span> prop<span class="token operator">=</span><span class="token string">&quot;password&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> field组件 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ValidateFormItem<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>ValidateForm<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>ValidateForm ref<span class="token operator">=</span><span class="token string">&quot;validateFormRef2&quot;</span> <span class="token operator">:</span>model<span class="token operator">=</span><span class="token string">&quot;formData2&quot;</span> <span class="token operator">:</span>rules<span class="token operator">=</span><span class="token string">&quot;rules&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>ValidateFormItem label<span class="token operator">=</span><span class="token string">&quot;用户名&quot;</span> prop<span class="token operator">=</span><span class="token string">&quot;keyword&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> field组件 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ValidateFormItem<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>ValidateFormItem label<span class="token operator">=</span><span class="token string">&quot;密码&quot;</span> prop<span class="token operator">=</span><span class="token string">&quot;password&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> field组件 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ValidateFormItem<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>ValidateForm<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>
</code></pre></div><p>示意图：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dddce9e4d09a4db5b07dd33cefafdc0a~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p><strong>事件中心总结</strong></p> <p>优点：</p> <ol><li>可以解决<code>Vue3</code>不能使用<code>this.$children</code>的问题</li> <li>可以灵活使用，不受组件层级的限制</li> <li>这种通信方式不受框架的限制</li></ol> <p>缺点：</p> <ol><li>需要控制好事件中心的作用范围</li> <li>需要控制好事件名的规范</li></ol> <h2 id="事件中心进阶"><a href="#事件中心进阶" class="header-anchor">#</a> 事件中心进阶</h2> <p>因为在<code>Vue3</code>的<code>Composition API</code>中，<code>vue</code>的功能 api 更加的颗粒化。我们可以对事件中心进行一个自定义需求的改造。</p> <p>可以通过引入<code>reactive, ref</code>帮助我们的事件中心内部维护一个响应式的数据，可以实现当事件中心进行一定通信行为时，去更新对应的视图。还可以引入<code>computed</code>实现计算属性的功能。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> reactive<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> computed <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Emitter</span> <span class="token punctuation">{</span>
  <span class="token comment">// 响应式的数据中心</span>
  <span class="token keyword">private</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> events<span class="token operator">:</span> EmitterHandles <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 记录当前事件中心 事件的数量</span>
  <span class="token keyword">private</span> eventLength <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>events<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>

  <span class="token comment">// 省略部分代码</span>
<span class="token punctuation">}</span>
</code></pre></div><p>加入<code>watch,watchEffect</code>实现数据监听做出一定逻辑行为的功能。我认为<code>Composition API</code>和<code>React Hooks Api</code>都是非常强大，因为它们允许我们将功能函数当成积木一样去任意组装成我们希望得到的应用程序。</p> <h2 id="深层后代向顶层通信-兄弟通信"><a href="#深层后代向顶层通信-兄弟通信" class="header-anchor">#</a> 深层后代向顶层通信，兄弟通信</h2> <p>我觉得其实其他的场景，其通信方式基本都差不多了，所谓千篇一律。后代向祖先传值，或者兄弟组件传值，都可以使用<code>vuex</code>或者是<code>事件中心</code>的方式。兄弟层级，或者相邻层级的，就可以使用<code>ref</code>,<code>$parent</code>等方式。</p> <h2 id="最后"><a href="#最后" class="header-anchor">#</a> 最后</h2> <p>我个人对<code>Vue3</code>还是非常看好的，目前对于公司的部分旧项目，也思考如何去用<code>Vue3</code>去重构它。然后我也是因为刚好看了社区大佬的文章绝对非常有意思，于是来了兴趣写了一个<code>Vue3</code>通信总结 😂，可能还有很多地方说的不是很到位。</p> <p>如果有错误或者是补充，欢迎大家在评论区留言，如果觉得还行对你有帮助就劳烦点个赞哈哈，🙏 谢谢各位靓仔靓女。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/tangmouren/Vue/" class="prev router-link-active">
        开始
      </a></span> <span class="next"><a href="/tangmouren/Vue/实现一个简单的Vue3框架.html">
        实现一个简单的Vue3框架
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/tangmouren/assets/js/app.6489800f.js" defer></script><script src="/tangmouren/assets/js/2.18399b14.js" defer></script><script src="/tangmouren/assets/js/10.fbff40b9.js" defer></script>
  </body>
</html>
